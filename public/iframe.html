<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plant-for-the-Planet Widget</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      #widget-container {
        width: 100%;
        height: 100%;
      }
      .error {
        color: #721c24;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 1rem;
        margin: 1rem;
        border-radius: 4px;
      }
    </style>
    <script>
      function showError(message) {
        const container = document.getElementById("widget-container");
        container.innerHTML = `<div class="error">${message}</div>`;
      }

      function loadWidget() {
        const params = new URLSearchParams(window.location.search);
        const widgetType = params.get("type");
        const user = params.get("user");
        const tenantKey =
          params.get("tenantKey") || params.get("tenantkey") || "ten_NxJq55pm"; // Use default tenant if none provided
        const theme = params.get("theme") || "default";
        const primarycolor = params.get("primarycolor") || "#68b030";
        const circlebgcolor = params.get("circlebgcolor") || "";
        const community = params.get("community") || "true";
        const locale = params.get("locale") || "en";
        const refresh = params.get("refresh") || "none";
        const forestname = params.get("forestname") || "";
        const project = params.get("project") || "";
        const goal = params.get("goal") || "";

        // Validate required parameters
        if (!widgetType) {
          showError("Missing required parameter: type is required");
          return;
        }
        if (
          (widgetType === "tree-map" || widgetType === "tree-profile") &&
          !user
        ) {
          showError(
            "Missing required parameter: user is required for this widget type"
          );
          return;
        }

        // Create the widget element first
        const widget = document.createElement(widgetType);
        const attributes = {
          tenantkey: tenantKey,
          theme: theme,
          primarycolor: primarycolor,
          community: community,
          locale: locale,
          refresh: refresh,
          id: widgetType,
          style: "width: 100%; height: 100%;",
        };

        // Add optional attributes
        if (user) attributes.user = user;
        if (circlebgcolor) attributes.circlebgcolor = circlebgcolor;
        if (forestname) attributes.forestname = forestname;
        if (project) attributes.project = project;
        if (goal) attributes.goal = goal;

        // Set all attributes
        Object.entries(attributes).forEach(([key, value]) => {
          widget.setAttribute(key, value);
        });

        // Add the widget to the container before loading the script
        const container = document.getElementById("widget-container");
        container.innerHTML = ""; // Clear any existing content
        container.appendChild(widget);

        // Now load the widget script
        const script = document.createElement("script");
        script.src = `/build/${widgetType}.js`;
        script.defer = true;
        script.id = `${widgetType}Script`;

        script.onerror = () => {
          showError(`Failed to load widget script: ${widgetType}.js`);
        };

        document.head.appendChild(script);
      }

      // Start loading the widget when the page is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", loadWidget);
      } else {
        loadWidget();
      }
    </script>
  </head>
  <body>
    <div id="widget-container"></div>
    <script>
      function showError(message) {
        const container = document.getElementById("widget-container");
        container.innerHTML = `<div class="error">${message}</div>`;
      }

      function loadWidget() {
        const params = new URLSearchParams(window.location.search);
        const widgetType = params.get("type");
        const user = params.get("user");
        const tenantKey =
          params.get("tenantKey") || params.get("tenantkey") || "ten_NxJq55pm"; // Use default tenant if none provided
        const theme = params.get("theme") || "default";
        const primarycolor = params.get("primarycolor") || "#68b030";
        const circlebgcolor = params.get("circlebgcolor") || "";
        const community = params.get("community") || "true";
        const locale = params.get("locale") || "en";
        const refresh = params.get("refresh") || "none";
        const forestname = params.get("forestname") || "";
        const project = params.get("project") || "";
        const goal = params.get("goal") || "";

        // Validate required parameters
        if (!widgetType) {
          showError("Missing required parameter: type is required");
          return;
        }
        if (
          (widgetType === "tree-map" || widgetType === "tree-profile") &&
          !user
        ) {
          showError(
            "Missing required parameter: user is required for this widget type"
          );
          return;
        }

        // Create the widget element first
        const widget = document.createElement(widgetType);
        const attributes = {
          tenantkey: tenantKey,
          theme: theme,
          primarycolor: primarycolor,
          community: community,
          locale: locale,
          refresh: refresh,
          id: widgetType,
          style: "width: 100%; height: 100%;",
        };

        // Add optional attributes
        if (user) attributes.user = user;
        if (circlebgcolor) attributes.circlebgcolor = circlebgcolor;
        if (forestname) attributes.forestname = forestname;
        if (project) attributes.project = project;
        if (goal) attributes.goal = goal;

        // Set all attributes
        Object.entries(attributes).forEach(([key, value]) => {
          widget.setAttribute(key, value);
        });

        // Add the widget to the container before loading the script
        const container = document.getElementById("widget-container");
        container.innerHTML = ""; // Clear any existing content
        container.appendChild(widget);

        // Now load the widget script
        const script = document.createElement("script");
        script.src = `/build/${widgetType}.js`;
        script.defer = true;
        script.id = `${widgetType}Script`;

        script.onerror = () => {
          showError(`Failed to load widget script: ${widgetType}.js`);
        };

        document.head.appendChild(script);
      }

      loadWidget();
    </script>
  </body>
</html>
